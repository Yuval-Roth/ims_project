<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby {{ lobby_id }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='lobby.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <!-- Home Button -->
    <a href="/main_menu" class="home-button">
        <img src="{{ url_for('static', filename='photos/home.png') }}" alt="Home" class="home-icon">
    </a>

    <!-- Lobby Container -->
    <div class="main-container">
        <div class="lobby-header">
            <h1>Lobby {{ lobby_id }}</h1>
        </div>

        <div class="lobby-content">
            <!-- Participants Section -->
            <section class="participants-section">
                <h2>Participants</h2>
                <div class="table-container">
                    <table class="styled-table participants-table">
                        <thead>
                            <tr>
                                <th>Player Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for participant in selected_participants %}
                            <tr>
                                <td>{{ participant }}</td>
                                <td id="status-{{ participant }}">Not Ready</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sessions Section -->
            <section class="sessions-section">
                <h2>Sessions</h2>
                <div class="table-container">
                    <div class="scrollable-table-container">

                        <table class="styled-table sessions-table">
                            <thead>
                                <tr>
                                    <th>Game Type</th>
                                    <th>Duration</th>
                                    <th>Session ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sessions-tbody">
                                {% for session in sessions %}
                                <tr data-session-id="{{ session.sessionId }}">
                                    <td>{{ session.gameType }}</td>
                                    <td>{{ session.duration }}</td>
                                    <td>{{ session.sessionId }}</td>
                                    <td>
                                        <button class="danger-button delete-session-btn" data-session-id="{{ session.sessionId }}">Delete</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button id="add-session-btn" class="primary-button">Add Session</button>
                <button id="toggle-game-btn" class="success-button" data-action="start" disabled>
                    Start Game
                </button>
                
            </div>
        </div>
    </div>

    <!-- Modal for Adding a Session -->
    <!-- Modal for Adding a Session -->
    <div id="add-session-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Add a Session</h2>
            <form id="add-session-form">
                <input type="hidden" name="lobby_id" value="{{ lobby_id }}">

                <label for="gameType">Game Type:</label>
                <select name="gameType" id="gameType" required>
                    {% for game in GAME_TYPE %}
                    <option value="{{ game.value }}">{{ game.value }}</option>
                    {% endfor %}
                </select>

                <label for="duration">Duration (minutes):</label>
                <input type="number" name="duration" id="duration" min="1" required>

                <!-- New Section: Sync Tolerance -->
                <label for="syncTolerance">Sync Tolerance (ms):</label>
                <input type="number" name="syncTolerance" id="syncTolerance" value="100" min="1" required>

                <!-- New Section: Window -->
                <label for="window">Window (ms):</label>
                <input type="number" name="window" id="window" value="2000" min="1" required>

                <div class="modal-actions">
                    <button type="submit" class="primary-button">Add</button>
                    <button type="button" id="cancel-modal-btn" class="cancel-button">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Modal Overlay -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const sessionTableBody = document.getElementById('sessions-tbody');
        const addSessionBtn = document.getElementById('add-session-btn');
        const modal = document.getElementById('add-session-modal');
        const overlay = document.getElementById('modal-overlay');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');

        // Show modal
        addSessionBtn.addEventListener('click', () => {
            modal.style.display = 'block';
            overlay.style.display = 'block';
        });

        // Hide modal
        cancelModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            overlay.style.display = 'none';
        });

        // Handle form submission via AJAX
        document.querySelector('#add-session-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            // Add default values for Sync Tolerance and Window if not explicitly set
            if (!formData.has('syncTolerance')) {
                formData.append('syncTolerance', 100); // Default value
            }
            if (!formData.has('window')) {
                formData.append('window', 2000); // Default value
            }

            fetch('/add_session', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const newSession = data.session;

                        // Append new session to the table
                        const row = document.createElement('tr');
                        row.dataset.sessionId = newSession.sessionId;
                        row.innerHTML = `
                            <td>${newSession.gameType}</td>
                            <td>${newSession.duration}</td>
                            <td>${newSession.sessionId}</td>
                            <td>
                                <button class="danger-button delete-session-btn" data-session-id="${newSession.sessionId}">Delete</button>
                            </td>
                        `;
                        sessionTableBody.appendChild(row);

                        // Hide modal
                        modal.style.display = 'none';
                        overlay.style.display = 'none';
                    } else {
                        alert('Failed to add session.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to add session.');
                });
        });


        // Handle Delete Session
        sessionTableBody.addEventListener('click', function (e) {
            if (e.target.classList.contains('delete-session-btn')) {
                const sessionId = e.target.dataset.sessionId;
                const lobbyId = "{{ lobby_id }}";

                fetch('/delete_session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lobby_id: lobbyId, session_id: sessionId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        e.target.closest('tr').remove();
                    } else {
                        alert('Failed to delete session.');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });

        // Enable drag-and-drop reordering
        new Sortable(sessionTableBody, {
            animation: 150,
            onEnd: function () {
                const sessionOrder = Array.from(sessionTableBody.children).map(row => row.dataset.sessionId);
                fetch('/update_session_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lobby_id: "{{ lobby_id }}", session_order: sessionOrder })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        alert('Failed to update session order.');
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });


    document.addEventListener('DOMContentLoaded', function () {
        const toggleGameBtn = document.getElementById('toggle-game-btn');
        const lobbyId = "{{ lobby_id }}";

        function updateButtonState(state, readyStatus) {
            if (state === 'waiting') {
                toggleGameBtn.textContent = 'Start Game';
                toggleGameBtn.dataset.action = 'start';
                toggleGameBtn.classList.remove('warning-button');
                toggleGameBtn.classList.add('success-button');
                // Enable the button only if all participants are ready
                toggleGameBtn.disabled = readyStatus.includes(false);
                console.log(toggleGameBtn.disabled);
            } else if (state === 'playing') {
                toggleGameBtn.textContent = 'Stop Game';
                toggleGameBtn.dataset.action = 'stop';
                toggleGameBtn.classList.remove('success-button');
                toggleGameBtn.classList.add('warning-button');
                toggleGameBtn.disabled = false;
            }
        }

        function updateParticipantStatuses(players, readyStatus) {
            players.forEach((player, index) => {
                const statusCell = document.getElementById(`status-${player}`);
                if (statusCell) {
                    statusCell.textContent = readyStatus[index] ? 'Ready' : 'Not Ready';
                    statusCell.classList.toggle('ready', readyStatus[index]);
                    statusCell.classList.toggle('not-ready', !readyStatus[index]);
                }
            });
        }

        function fetchLobbyState() {
            fetch(`/get_lobby`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lobby_id: lobbyId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const lobby = data.lobby;
                    updateButtonState(lobby.state, lobby.readyStatus);
                    updateParticipantStatuses(lobby.players, lobby.readyStatus);
                } else {
                    console.error('Error fetching lobby state:', data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        toggleGameBtn.addEventListener('click', () => {
            const action = toggleGameBtn.dataset.action;

            fetch(`/${action}_game`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lobby_id: lobbyId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    fetchLobbyState(); // Refresh the lobby state after action
                } else {
                    alert(`Failed to ${action} the game.`);
                }
            })
            .catch(error => {
                console.error(`Error performing ${action}:`, error);
                alert(`Failed to ${action} the game.`);
            });
        });

        // Poll for the lobby state every 5 seconds
        setInterval(fetchLobbyState, 5000);

        // Initial state fetch on page load
        fetchLobbyState();
    });



    </script>
</body>
</html>
