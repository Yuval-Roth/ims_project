<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Single Session Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- site-wide css -->
  <link rel="stylesheet" href="{{ url_for('static', filename='general.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='session_data.css') }}">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* 2-column responsive grid for the six charts */
    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
      gap:40px;
      margin-top:30px;
    }
    .chart-container{
      position:relative;
      width:100%;
      height:300px;
    }
    /* full-screen look & feel */
    .chart-container:fullscreen{
      width:100vw;
      height:100vh;
      background:#fff;
      padding:12px;
      box-sizing:border-box;
    }
  </style>
</head>

<body>
<a href="/session_data" class="home-button">
  <img src="{{ url_for('static', filename='photos/home.png') }}" alt="Home" class="home-icon">
</a>

<div class="session-container">
  <h1>Session&nbsp;ID:&nbsp;#{{ metadata.sessionId }}</h1>
  <p style="text-align:center;">
    <strong>Game&nbsp;Type:</strong>&nbsp;{{ metadata.gameType.replace('_',' ').title() }}&nbsp;|
    <strong>Duration:</strong>&nbsp;{{ metadata.duration }}&nbsp;s&nbsp;|
    <strong>Participants:</strong>&nbsp;{{ metadata.participants|join(' & ') }}
  </p>

  <div class="charts-grid">
    <!-- ❶  Heart-rate mock (placeholder) -->
    <div class="chart-container">
      <h3 style="text-align:center;">Heart&nbsp;Rate</h3>
      <canvas id="hrChart"></canvas>
    </div>

    <!-- ❷  HRV mock (placeholder) -->
    <div class="chart-container">
      <h3 style="text-align:center;">HR&nbsp;Variation</h3>
      <canvas id="hrvChart"></canvas>
    </div>

    <!-- ❸  Network latency -->
    <div class="chart-container">
      <h3 style="text-align:center;">Latency</h3>
      <canvas id="latencyChart"></canvas>
    </div>

    <!-- ❹  Input intensity -->
    <div class="chart-container">
      <h3 style="text-align:center;">Input&nbsp;Intensity</h3>
      <canvas id="intensityChart"></canvas>
    </div>

    <!-- ❺  Pearson r (10-s) -->
    <div class="chart-container">
      <h3 style="text-align:center;">Pearson&nbsp;r&nbsp;(10-s window)</h3>
      <canvas id="pearsonChart"></canvas>
    </div>

    <!-- ❻  Sync level (0-1) over time if you keep it; otherwise remove -->
    <div class="chart-container">
      <h3 style="text-align:center;">Sync&nbsp;Over&nbsp;Time</h3>
      <canvas id="syncChart"></canvas>
    </div>
  </div>
</div>

<script>
/* ───────────────────────── data injected from Flask ───────────────────────── */
const meta           = {{ metadata|tojson }};
const latencyData    = {{ sync_data|tojson }};        // labels + actors
const intensityData  = {{ intensity_data|tojson }};
const pearsonData    = {{ pearson_data|tojson }};
const sttValue       = {{ stt|default('null') }};

/* ----------  fullscreen helper  ---------- */
document.querySelectorAll('.chart-container').forEach(c => {
  c.addEventListener('dblclick', () => {
    if (!document.fullscreenElement){
      (c.requestFullscreen||c.webkitRequestFullscreen||
       c.mozRequestFullScreen||c.msRequestFullscreen).call(c);
    }else{
      (document.exitFullscreen||document.webkitExitFullscreen||
       document.mozCancelFullScreen||document.msExitFullscreen).call(document);
    }
  });
});

/* ----------  helpers ---------- */
function makeDatasets(src, cfg={}) {
  /* turn {actor1:[…],actor2:[…]} → Chart.js datasets */
  return meta.participants.map(name => ({
    label:name,
    data:src[name] ?? [],
    tension:0.3,
    fill:false,
    ...cfg
  }));
}

/* ----------  build charts ---------- */

/* ❶ quick placeholder HR / HRV using randoms – replace when real data arrives */
function rand(len,min,max){
  return Array.from({length:len},()=>+(Math.random()*(max-min)+min).toFixed(2));
}
const mockLabels=[...Array( latencyData.labels.length||20 ).keys()].map(String);

new Chart(hrChart,{
  type:'line',
  data:{labels:mockLabels,
        datasets:makeDatasets(Object.fromEntries(meta.participants.map(n=>[n,rand(mockLabels.length,60,100)])))},
  options:{responsive:true,scales:{y:{title:{display:true,text:'BPM'}}}}
});
new Chart(hrvChart,{
  type:'line',
  data:{labels:mockLabels,
        datasets:makeDatasets(Object.fromEntries(meta.participants.map(n=>[n,rand(mockLabels.length,5,20)])))},
  options:{responsive:true,scales:{y:{title:{display:true,text:'ms'}}}}
});

/* ❸ latency */
new Chart(latencyChart,{
  type:'bar',
  data:{labels:latencyData.labels,datasets:makeDatasets(latencyData)},
  options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'ms'}}}}
});

/* ❹ intensity */
new Chart(intensityChart,{
  type:'line',
  data:{labels:intensityData.labels,datasets:makeDatasets(intensityData)},
  options:{responsive:true,scales:{y:{beginAtZero:true,title:{display:true,text:'Count / 2 s'}}}}
});

/* ❺ Pearson r */
if(pearsonData.labels && pearsonData.labels.length){
  new Chart(pearsonChart,{
    type:'line',
    data:{labels:pearsonData.labels,datasets:makeDatasets(pearsonData,{tension:0})},
    options:{responsive:true,scales:{y:{min:-1,max:1,title:{display:true,text:'r'}}}}
  });
}else{
  pearsonChart.parentElement.style.display='none';
}

/* ❻ Sync-over-time – use latencyData here or your own metric */
new Chart(syncChart,{
  type:'line',
  data:{labels:latencyData.labels,datasets:makeDatasets(latencyData,{tension:0.4})},
  options:{responsive:true,scales:{y:{beginAtZero:true,max:1,title:{display:true,text:'Sync'}}}}
});

/* ----------  show STT if present ---------- */
if(sttValue!==null){
  document.querySelector('.session-container').insertAdjacentHTML(
    'beforeend',
    `<p style="text-align:center;margin-top:8px;">
       <strong>Shared&nbsp;Tempo&nbsp;Time:</strong>&nbsp;${(sttValue*100).toFixed(1)}%
     </p>`);
}
</script>
</body>
</html>
