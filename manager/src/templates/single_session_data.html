<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Single Session Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="{{ url_for('static', filename='general.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='session_data.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

  <style>
    .charts-grid{
      display:flex;
      flex-direction:column;
      gap:50px;
      align-items:center;
      margin:40px auto;
    }
    .chart-container{
      width:90vw;
      max-width:1200px;
      height:420px;
      position:relative;
    }
    .chart-container:fullscreen{
      width:100vw;height:100vh;background:#fff;padding:12px;box-sizing:border-box;
    }
  </style>
</head>

<body>
<a href="/session_data" class="home-button">
  <img src="{{ url_for('static', filename='photos/home.png') }}" alt="Home" class="home-icon">
</a>

<div class="session-container">
  <h1>Session&nbsp;ID:&nbsp;#{{ metadata.sessionId }}</h1>
  <p style="text-align:center;">
    <strong>Game&nbsp;Type:</strong>&nbsp;{{ metadata.gameType.replace('_',' ').title() }}&nbsp;|
    <strong>Duration:</strong>&nbsp;{{ metadata.duration }}&nbsp;s&nbsp;|
    <strong>Participants:</strong>&nbsp;{{ metadata.participants|join(' & ') }}
  </p>

  <div class="charts-grid">
    <div class="chart-container"><h3 style="text-align:center;" id="gameChartTitle"></h3><canvas id="gameChart"></canvas></div>
    <div class="chart-container"><h3 style="text-align:center;">Heart Rate</h3><canvas id="hrChart"></canvas></div>
    <div class="chart-container"><h3 style="text-align:center;">HR Variation</h3><canvas id="hrvChart"></canvas></div>
    <div class="chart-container"><h3 style="text-align:center;">Latency</h3><canvas id="latencyChart"></canvas></div>
    <div class="chart-container"><h3 style="text-align:center;">Jitter</h3><canvas id="jitterChart"></canvas></div>
  </div>
</div>

<script>
/* ---- data from Flask ---- */
const meta           = {{ metadata|tojson }};
const heartData      = {{ data.heart|tojson }};
const hrvData        = {{ data.hrv|tojson }};
const latencyData    = {{ data.latency|tojson }};
const jitterData     = {{ data.jitter|tojson }};
const clickEvents    = {{ data.click_events|tojson }};
const syncEvents     = {{ data.sync_events|tojson }};
const frequencyData  = {{ data.frequency_data|tojson }};
const syncIntervals  = {{ data.sync_intervals|tojson }};

/* ---- helpers ---- */
function dictToDatasets(dict, extra={}){
  return Object.keys(dict).map(actor=>({
    label:actor,
    data:dict[actor].timestamps.map((t,i)=>({x:+t,y:+dict[actor].values[i]})),
    pointRadius:3,tension:.3,fill:false,
    ...extra
  }));
}
function makeLine(canvas, datasets, yLab){
  new Chart(canvas,{
    type:'line',
    data:{datasets},
    options:{
      parsing:false,
      responsive:true,
      scales:{
        x:{type:'linear',title:{display:true,text:'Time (s)'}},
        y:{title:{display:true,text:yLab}}
      },
      plugins:{tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y}`}}}
    }
  });
}

/* ---- metric charts ---- */
makeLine(hrChart,  dictToDatasets(heartData), 'BPM');
makeLine(hrvChart, dictToDatasets(hrvData),  'ms');
makeLine(latencyChart,
         dictToDatasets(latencyData,{pointRadius:0,tension:.4,
                                      backgroundColor:'rgba(60,150,255,.08)',fill:'origin'}),'ms');
makeLine(jitterChart, dictToDatasets(jitterData), 'ms');

/* ---- Clicks & Sync custom chart ---- */
const titleEl=document.getElementById('gameChartTitle');

if (clickEvents){
  titleEl.textContent='Clicks & Sync Markers';

  const actors=Object.keys(clickEvents).sort();  // first actor -> red/top, second -> blue/bottom
  const topA   = actors[0]||'A';
  const bottomA= actors[1]||'B';

  /* build vertical-line annotations */
  const annotations=[];

  (clickEvents[topA]||[]).forEach(t=>{
    annotations.push({type:'line',xMin:+t,xMax:+t,yMin:0.5,yMax:1,borderColor:'red',borderWidth:2});
  });
  (clickEvents[bottomA]||[]).forEach(t=>{
    annotations.push({type:'line',xMin:+t,xMax:+t,yMin:0,yMax:0.5,borderColor:'blue',borderWidth:2});
  });
  (syncEvents||[]).forEach(t=>{
    annotations.push({type:'line',xMin:+t,xMax:+t,yMin:0,yMax:1,borderColor:'gold',borderWidth:3});
  });

  /* dummy datasets only for legend colours */
  const legendSets=[
    {label:`${topA} Click`, data:[], borderColor:'red', borderWidth:2},
    {label:`${bottomA} Click`, data:[], borderColor:'blue', borderWidth:2},
    {label:'Sync', data:[], borderColor:'gold', borderWidth:3}
  ];

  new Chart(gameChart,{
    type:'line',
    data:{datasets:legendSets},
    options:{
      parsing:false,
      responsive:true,
      scales:{
        x:{type:'linear',title:{display:true,text:'Time (s)'}},
        y:{display:false,min:0,max:1}
      },
      plugins:{
        annotation:{annotations},
        legend:{labels:{usePointStyle:true}}
      }
    },
    plugins:[Chart.registry.getPlugin('annotation')]
  });

}else if (frequencyData){
  /* --- SWIPE game (unchanged) --- */
  titleEl.textContent='Finger Frequency & Sync Intervals';
  new Chart(gameChart,{
    type:'line',
    data:{datasets:dictToDatasets(frequencyData,{pointRadius:0})},
    options:{
      parsing:false,responsive:true,
      scales:{
        x:{type:'linear',title:{display:true,text:'Time (s)'}},
        y:{title:{display:true,text:'Hz'}}
      },
      plugins:{
        annotation:{annotations:(syncIntervals||[]).map(([s,e])=>({
          type:'box',xMin:s,xMax:e,backgroundColor:'rgba(180,180,180,.15)'}))},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.parsed.y}`}}
      }
    },
    plugins:[Chart.registry.getPlugin('annotation')]
  });
}else{
  titleEl.textContent='(No game-specific data)';
}

/* ---- fullscreen on double-click ---- */
document.querySelectorAll('.chart-container').forEach(c=>{
  c.addEventListener('dblclick',()=>{
    if(!document.fullscreenElement){
      (c.requestFullscreen||c.webkitRequestFullscreen||
       c.mozRequestFullScreen||c.msRequestFullscreen).call(c);
    }else{
      (document.exitFullscreen||document.webkitExitFullscreen||
       document.mozCancelFullScreen||document.msExitFullscreen).call(document);
    }
  });
});
</script>
</body>
</html>
