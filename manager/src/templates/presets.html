<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presets</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='general.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='presets.css') }}">
</head>
<body>
  <!-- Home Button -->
  <a href="/main_menu" class="home-button">
    <img src="{{ url_for('static', filename='photos/home.png') }}" alt="Home" class="home-icon">
  </a>

  <div class="main-container">
    <div class="header-bar">
      <h1>Presets</h1>
    </div>

    <div class="content-area" id="presets-container">
      <div id="presets-wrapper" class="presets-wrapper">
        <p>Loading presets...</p>
      </div>

      <div class="action-buttons">
        <button id="add-preset-btn" class="primary-button">Add Preset</button>
      </div>
    </div>
  </div>

  <!-- Add New Preset Modal -->
  <div id="preset-name-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2>Add New Preset</h2>
      <form id="preset-name-form">
        <label for="presetName">Preset Name:</label>
        <input type="text" id="presetName" name="presetName" required placeholder="Enter preset name">

        <div class="modal-actions">
          <button type="button" id="cancel-preset-btn" class="cancel-button">Cancel</button>
          <button type="submit" class="primary-button">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Existing Add/Edit Session Modal -->
  <div id="session-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <h2 id="session-modal-title">Add Session</h2>
      <form id="session-form">
        <label for="gameType">Game Type:</label>
        <select id="gameType" name="gameType" class="styled-select" required>
          <option value="Water Ripples">Water Ripples</option>
          <option value="Wine Glasses">Wine Glasses</option>
          <option value="Flour Mill">Flour Mill</option>
          <option value="Flower Garden">Flower Garden</option>
          <option value="Pacman">Pacman</option>
          <option value="Waves">Waves</option>
        </select>

        <label for="duration">Duration (seconds):</label>
        <input type="number" id="duration" name="duration" required>

        <label id="syncToleranceDescription" for="syncTolerance"></label>
        <input type="number" id="syncTolerance" name="syncTolerance" required>

        <label for="window">Sync Window Length (ms):</label>
        <input type="number" id="window" name="window" required>

        <label for="isWarmup">Is Warmup:</label>
        <select id="isWarmup" name="isWarmup" class="styled-select" required>
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>

        <div class="modal-actions">
          <button type="button" id="cancel-modal-btn" class="cancel-button">Cancel</button>
          <button type="submit" class="primary-button">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div id="modal-overlay" class="modal-overlay" style="display:none;"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const presetsWrapper = document.getElementById('presets-wrapper');
    const addPresetBtn = document.getElementById('add-preset-btn');
    const presetModal = document.getElementById('preset-name-modal');
    const presetForm = document.getElementById('preset-name-form');
    const cancelPresetBtn = document.getElementById('cancel-preset-btn');
    const overlay = document.getElementById('modal-overlay');

    const sessionModal = document.getElementById('session-modal');
    const cancelSessionModalBtn = document.getElementById('cancel-modal-btn');
    const sessionForm = document.getElementById('session-form');

    let presets = [];
    let currentPresetName = null;

    class Session {
        constructor(gameType, duration, syncTolerance, syncWindowLength, isWarmup) {
            this.gameType = gameType;
            this.duration = duration;
            this.syncTolerance = syncTolerance;
            this.syncWindowLength = syncWindowLength;
            this.isWarmup = isWarmup;
        }
    }

    // ───────────────────── Fetch Presets
    async function fetchPresets() {
        const res = await fetch('/get_presets');
        const data = await res.json();
        if (data.status === 'success') {
            presets = data.payload;
            renderPresets();
        } else {
            presetsWrapper.innerHTML = '<p>Failed to load presets.</p>';
        }
    }

    // ───────────────────── Render Presets
    function renderPresets() {
        presetsWrapper.innerHTML = '';
        if (!presets || presets.length === 0) {
            presetsWrapper.innerHTML = '<p>No presets found.</p>';
            return;
        }

        presets.forEach(preset => {
            if(!preset.sessions) preset.sessions = [];
            console.log(preset)
            const section = document.createElement('section');
            section.className = 'preset-block';
            section.innerHTML = `
                <div class="preset-header">
                    <h2>${preset.name}</h2>
                    <div class="preset-actions">
                        <button class="primary-button" data-name="${preset.name}" data-action="add-session">Add Session</button>
                        <button class="danger-button" data-name="${preset.name}" data-action="delete-preset">Delete Preset</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="styled-table">
                        <thead>
                            <tr>
                                <th>Game Type</th>
                                <th>Duration</th>
                                <th>Sync Tolerance</th>
                                <th>Sync Window</th>
                                <th>Is Warmup</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-${preset.name}">
                            ${preset.sessions.map((s, i) => `
                                <tr data-index="${i}">
                                    <td>${s.gameType}</td>
                                    <td>${s.duration}</td>
                                    <td>${formatSyncTolerance(s)}</td>
                                    <td>${formatSyncWindow(s)}</td>
                                    <td>${s.isWarmup ? 'Yes' : 'No'}</td>
                                    <td><button class="danger-button" data-name="${preset.name}" data-index="${i}" data-action="delete-session">Delete</button></td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            presetsWrapper.appendChild(section);
        });
    }

    // ───────────────────── Formatters
    function formatSyncTolerance(s) {
        if (s.syncTolerance === -1) return 'N/A';
        if (s.gameType === 'Wine Glasses' || s.gameType === 'Flour Mill')
            return (s.syncTolerance / 100) + ' Hz';
        return s.syncTolerance + ' ms';
    }

    function formatSyncWindow(s) {
        return s.syncWindowLength === -1 ? 'N/A' : s.syncWindowLength + ' ms';
    }

    // ───────────────────── Preset Modal
    addPresetBtn.addEventListener('click', () => {
        presetForm.reset();
        presetModal.style.display = 'block';
        overlay.style.display = 'block';
    });

    cancelPresetBtn.addEventListener('click', closeAllModals);
    overlay.addEventListener('click', closeAllModals);

    function closeAllModals() {
        presetModal.style.display = 'none';
        sessionModal.style.display = 'none';
        overlay.style.display = 'none';
    }

    presetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('presetName').value.trim();
        if (!name) return;

        await fetch('/add_preset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        closeAllModals();
        fetchPresets();
    });

    // ───────────────────── Session Modal
    cancelSessionModalBtn.addEventListener('click', closeAllModals);

    // ───────────────────── Handle Actions
    presetsWrapper.addEventListener('click', async e => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const { action, name, index } = btn.dataset;

        if (action === 'add-session') {
            currentPresetName = name;
            sessionForm.reset();
            document.getElementById('session-modal').style.display = 'block';
            overlay.style.display = 'block';
        } else if (action === 'delete-session') {
            const preset = presets.find(p => p.name === name);
            preset.sessions.splice(index, 1);
            await fetch('/update_preset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(preset)
            });
            await fetchPresets();
        } else if (action === 'delete-preset') {
            if (!confirm(`Delete preset "${name}"?`)) return;
            await fetch('/delete_preset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            await fetchPresets();
        }
    });

    fetchPresets();
});
</script>
</body>
</html>
